<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovator's Gambit: Bidding Floor</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Modern UI/UX Overhaul */
        :root {
            --gold: #FFC72C;
            --dark-blue: #0A192F;
            --medium-blue: #112240;
            --light-gray: #CCD6F6;
            --accent-red: #E84A5F;
        }

        body {
            background-color: var(--dark-blue);
            color: var(--light-gray);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
        }

        .gold-rush-theme {
            background: linear-gradient(90deg, #112240, #0A192F);
            border-bottom: 4px solid var(--gold);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-info {
            font-size: 1.2em;
            font-weight: bold;
        }

        #vc-balance {
            color: var(--gold);
            margin-left: 15px;
        }

        #logout-btn {
            background-color: var(--accent-red);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 20px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #logout-btn:hover {
            background-color: #c4384c;
        }

        .tabs button {
            background-color: var(--medium-blue);
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            transition: background-color 0.2s;
        }
        .tabs button.active {
            background-color: var(--gold);
            color: var(--dark-blue);
            font-weight: bold;
        }

        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            padding: 30px;
        }

        .item-card {
            background-color: var(--medium-blue);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s;
            border-left: 5px solid var(--accent-red);
        }
        .item-card:hover {
            transform: translateY(-3px);
        }

        .item-card h3 {
            color: var(--gold);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
            margin-top: 0;
        }

        .item-card input[type="number"] { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            box-sizing: border-box; 
            background-color: var(--dark-blue); 
            color: var(--light-gray); 
            border: 1px solid var(--light-gray); 
            border-radius: 6px; 
            transition: border-color 0.3s;
        }
        .item-card input[type="number"]:focus {
            border-color: var(--gold);
            outline: none;
        }

        .item-card button { 
            background: linear-gradient(45deg, #00FF00, #00B300); /* Green Gradient for Action */
            color: var(--dark-blue); 
            padding: 12px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            width: 100%; 
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 150, 0, 0.3);
            transition: opacity 0.3s;
        }
        .item-card button:hover {
            opacity: 0.9;
        }
        .item-card button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .bid-summary {
            background-color: var(--dark-blue);
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed var(--light-gray);
            margin-top: 20px;
        }
        .summary-total {
            font-size: 1.3em;
            color: var(--accent-red);
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header class="gold-rush-theme">
        <div class="header-left">
            <h1 class="event-title">Innovator's Gambit</h1>
            <div class="header-info">
                <span id="team-name">Loading Team...</span> | 
                <span id="vc-balance">$VC 0</span>
            </div>
        </div>
        <button id="logout-btn" onclick="window.location.href='/logout'">Logout</button>
    </header>

    <div style="padding: 20px 40px;">
        <h2 style="color: var(--accent-red);">Time Remaining: <span id="timer">--:--</span></h2>
        <div id="status-message">Connecting...</div>

        <div class="tabs">
            <button id="tab-bidding" class="active" onclick="showSection('bidding')">Live Bidding</button>
            <button id="tab-assets" onclick="showSection('assets')">My Assets</button>
        </div>
    </div>
    
    <div class="bid-summary" style="padding: 20px 40px;">
        <h3>💰 Projected Total Cost of Wins (Strategy Check):</h3>
        <p class="summary-total" id="projected-cost">$VC 0</p>
    </div>

    <section id="bidding-section" class="item-list">
        </section>
    
    <section id="assets-section" style="display: none; padding: 30px;">
        <h2>Assets Won (Day 2 Pitch Materials)</h2>
        <ul id="my-assets-list">
            <li>Loading...</li>
        </ul>
        <p style="font-weight: bold; margin-top: 15px;">Final Acquired Value: <span id="my-assets-total">$VC 0</span></p>
    </section>

    <script>
        let TEAM_ID = null;
        let teamData = {};
        let assetCatalog = {};
        let auctionActive = false;
        
        const VC_BALANCE_EL = document.getElementById('vc-balance');
        const TEAM_NAME_EL = document.getElementById('team-name');
        const TIMER_EL = document.getElementById('timer');
        const STATUS_MSG_EL = document.getElementById('status-message');
        const ASSETS_DISPLAY_EL = document.getElementById('bidding-section');
        const MY_ASSETS_LIST_EL = document.getElementById('my-assets-list');
        const MY_ASSETS_TOTAL_EL = document.getElementById('my-assets-total');
        const PROJECTED_COST_EL = document.getElementById('projected-cost');
        
        // FIX: The socket connection should be clean now
        const socket = io();

        const formatVC = (amount) => `$${amount.toLocaleString()}`;
        
        function showSection(id) {
            document.getElementById('bidding-section').style.display = 'none';
            document.getElementById('assets-section').style.display = 'none';
            
            document.getElementById(`tab-bidding`).classList.remove('active');
            document.getElementById(`tab-assets`).classList.remove('active');
            
            document.getElementById(`${id}-section`).style.display = id === 'assets' ? 'block' : 'grid'; // Assets is a block layout
            document.getElementById(`tab-${id}`).classList.add('active');
        }

        function calculateProjectedCost() {
            let projectedCost = 0;
            for (const id in assetCatalog) {
                const asset = assetCatalog[id];
                const teamBid = asset.current_bids[TEAM_ID] || 0;
                
                // If team is the highest bidder and bid > 0, assume win at their bid price
                // NOTE: This is a simple projection. The actual final price is Uniform Price.
                // For simplicity, we assume they pay their max bid for the purpose of checking budget risk.
                
                if (teamBid > 0) {
                    const topBids = Object.values(asset.current_bids).sort((a, b) => b - a);
                    // Check if their bid is within the top 'quantity' bids
                    const rank = topBids.indexOf(teamBid);
                    
                    if (rank !== -1 && rank < asset.quantity) {
                         projectedCost += (teamBid * asset.quantity); // Simple projection for budgeting
                    }
                }
            }
            PROJECTED_COST_EL.textContent = formatVC(projectedCost);
        }

        function updateTeamDisplay(team) {
            teamData = team;
            TEAM_NAME_EL.textContent = team.name;
            VC_BALANCE_EL.textContent = formatVC(team.vc);
            renderMyAssets();
            calculateProjectedCost();
        }
        
        function renderMyAssets() {
            let totalAcquiredValue = 0;
            MY_ASSETS_LIST_EL.innerHTML = ''; 
            
            if (teamData.assets_won.length > 0) {
                teamData.assets_won.forEach(asset => {
                    const finalCost = asset.cost * asset.quantity;
                    MY_ASSETS_LIST_EL.innerHTML += `<li>${asset.name} (x${asset.quantity}) - Total Cost: ${formatVC(finalCost)} (Price/Unit: ${formatVC(asset.cost)})</li>`;
                    totalAcquiredValue += finalCost;
                });
            } else {
                MY_ASSETS_LIST_EL.innerHTML = '<li>No assets won yet. Bid now!</li>';
            }
            MY_ASSETS_TOTAL_EL.textContent = formatVC(totalAcquiredValue);
        }

        function renderAssetCards() {
            ASSETS_DISPLAY_EL.innerHTML = '';
            for (const id in assetCatalog) {
                const asset = assetCatalog[id];
                const teamBid = asset.current_bids[TEAM_ID] || 0;
                
                const card = document.createElement('div');
                card.className = 'item-card';
                
                // ... (Winning Pool and Bid Controls HTML logic remains the same)
                let winnerStatus = '';
                if (!auctionActive && asset.winner) {
                    winnerStatus = `<p style="margin-top: 10px; font-weight: bold; color: #FFC72C;">AUCTION RESULT:</p>`;
                    
                    if (asset.winner === 'MULTIPLE' && asset.winning_pool.includes(TEAM_ID)) {
                        winnerStatus += `<p style="color: #00FF00;">🎉 YOU WON 1 UNIT at ${formatVC(asset.final_price)}!</p>`;
                    } else if (asset.winner === 'MULTIPLE') {
                        winnerStatus += `<p>Sold ${asset.quantity} units. Uniform Price: ${formatVC(asset.final_price)}</p>`;
                    } else if (asset.winner === 'VOID (Budget Fail)') {
                        winnerStatus += `<p style="color: orange; font-weight: bold;">VOID: Team over budget.</p>`;
                    } else {
                        winnerStatus += `<p>No units won.</p>`;
                    }
                }
                
                let bidControlsHTML = '';
                if (auctionActive) {
                     bidControlsHTML = `
                        <p style="font-weight: bold;">Units Available: x${asset.quantity}</p>
                        <label for="bid-${id}">Your Bid (Price per unit):</label>
                        <input type="number" id="bid-${id}" value="${teamBid}" min="${asset.min_bid}">
                        <button onclick="placeBid('${id}')">
                            ${teamBid > 0 ? 'Update Bid' : 'Place Bid'}
                        </button>
                        <div class="bid-status" id="status-${id}">
                            ${teamBid > 0 ? `Current Bid/Unit: ${formatVC(teamBid)}` : 'No bid recorded.'}
                        </div>
                    `;
                } else {
                    bidControlsHTML = `<div class="bid-status">Auction is CLOSED.</div>`;
                }


                card.innerHTML = `
                    <h3>${asset.name} (${asset.category})</h3>
                    <p>Min Bid/Unit: ${formatVC(asset.min_bid)}</p>
                    <p>Description: Strategic value details for pitching.</p>
                    <div class="bid-section">${bidControlsHTML}</div>
                    ${winnerStatus}
                `;
                ASSETS_DISPLAY_EL.appendChild(card);
            }
        }

        window.placeBid = (assetId) => {
            // ... (existing placeBid logic remains the same) ...
            const input = document.getElementById(`bid-${assetId}`);
            const bidAmount = parseInt(input.value);

            if (!auctionActive) { return; }

            if (isNaN(bidAmount) || bidAmount < assetCatalog[assetId].min_bid) {
                alert(`Bid for ${assetCatalog[assetId].name} must be a valid number and at least ${formatVC(assetCatalog[assetId].min_bid)} (per unit).`);
                return;
            }
            
            socket.emit('place_bid', {
                assetId: assetId,
                bidAmount: bidAmount
            });
        }
        
        // --- Socket.IO Event Handlers ---
        
        socket.on('initial_state', (state) => {
            TEAM_ID = state.teamId;
            updateTeamDisplay(state.teamData);
            assetCatalog = state.assets;
            auctionActive = state.active;
            
            renderAssetCards();
            STATUS_MSG_EL.textContent = auctionActive ? 'Auction is LIVE! Place your sealed bids now.' : 'Auction is CLOSED. Review results and assets.';
            
            // FIX: If team data is missing (shouldn't happen with the server fixes, but just in case)
            if (!state.teamData) {
                window.location.href = '/logout'; 
            }
        });

        socket.on('timer_update', (data) => {
            const time_left = data.timeLeft;
            const minutes = Math.floor(time_left / 60);
            const seconds = time_left % 60;
            TIMER_EL.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        });
        
        socket.on('bid_response', (data) => {
            const statusEl = document.getElementById(`status-${data.assetId}`);
            if (data.success) {
                statusEl.innerHTML = `<span style="color: #00FF00;">✅ ${data.message}</span>`;
                assetCatalog[data.assetId].current_bids[TEAM_ID] = data.newBid;
                document.querySelector(`#bid-${data.assetId}`).nextElementSibling.textContent = 'Update Bid';
                calculateProjectedCost(); // Update summary after every bid
            } else {
                statusEl.innerHTML = `<span style="color: #FF0000;">❌ ${data.message}</span>`;
            }
        });

        socket.on('admin_update_teams', (teamsData) => {
             if (teamsData[TEAM_ID]) {
                updateTeamDisplay(teamsData[TEAM_ID]);
             }
        });
        
        // ... (rest of the socket handlers remain the same) ...
    </script>
</body>
</html>