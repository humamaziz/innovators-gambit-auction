<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovator's Gambit: Bidding Floor</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .tabs button {
            background-color: #112240;
            color: #FFC72C;
            border: 1px solid #FFC72C;
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        .tabs button:hover {
            background-color: #0A192F;
        }
        .tabs button.active {
            background-color: #FFC72C;
            color: #0A192F;
        }
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        #assets-section ul {
            list-style: none;
            padding: 0;
        }
        #assets-section li {
            background-color: #112240;
            padding: 10px;
            margin-bottom: 5px;
            border-left: 5px solid #E84A5F;
        }
    </style>
</head>
<body>

    <header class="gold-rush-theme">
        <h1 class="event-title">Innovator's Gambit: Bidding Floor</h1>
        <div id="team-info">
            <span id="team-name">Loading...</span> | 
            <span id="vc-balance">$VC 0</span>
        </div>
    </header>

    <div style="padding: 20px;">
        <h2 style="color: #E84A5F;">Time Remaining: <span id="timer">--:--</span></h2>
        <div id="status-message">Connecting...</div>

        <div class="tabs">
            <button id="tab-bidding" class="active" onclick="showSection('bidding')">Live Bidding</button>
            <button id="tab-assets" onclick="showSection('assets')">My Assets</button>
        </div>
    </div>
    
    <section id="bidding-section" class="item-list">
        </section>
    
    <section id="assets-section" style="display: none; padding: 30px;">
        <h2>Assets Won (Day 2 Pitch Materials)</h2>
        <ul id="my-assets-list">
            <li>Loading...</li>
        </ul>
        <p style="font-weight: bold; margin-top: 15px;">Total Assets Cost: <span id="my-assets-total">$VC 0</span></p>
    </section>

    <script>
        let TEAM_ID = null;
        let teamData = {};
        let assetCatalog = {};
        let auctionActive = false;
        
        const VC_BALANCE_EL = document.getElementById('vc-balance');
        const TEAM_NAME_EL = document.getElementById('team-name');
        const TIMER_EL = document.getElementById('timer');
        const STATUS_MSG_EL = document.getElementById('status-message');
        const ASSETS_DISPLAY_EL = document.getElementById('bidding-section');
        const MY_ASSETS_LIST_EL = document.getElementById('my-assets-list');
        const MY_ASSETS_TOTAL_EL = document.getElementById('my-assets-total');
        
        const socket = io();

        const formatVC = (amount) => `$${amount.toLocaleString()}`;
        
        function showSection(id) {
            document.getElementById('bidding-section').style.display = 'none';
            document.getElementById('assets-section').style.display = 'none';
            
            document.getElementById(`tab-bidding`).classList.remove('active');
            document.getElementById(`tab-assets`).classList.remove('active');
            
            document.getElementById(`${id}-section`).style.display = 'grid';
            document.getElementById(`tab-${id}`).classList.add('active');
        }

        function updateTeamDisplay(team) {
            teamData = team;
            TEAM_NAME_EL.textContent = `Team: ${team.name}`;
            VC_BALANCE_EL.textContent = formatVC(team.vc);
            renderMyAssets();
        }
        
        function renderMyAssets() {
            let totalCost = 0;
            MY_ASSETS_LIST_EL.innerHTML = ''; 
            
            if (teamData.assets_won.length > 0) {
                teamData.assets_won.forEach(asset => {
                    MY_ASSETS_LIST_EL.innerHTML += `<li>${asset.name} (x${asset.quantity}) - Cost: ${formatVC(asset.cost * asset.quantity)} (Price/Unit: ${formatVC(asset.cost)})</li>`;
                    totalCost += (asset.cost * asset.quantity);
                });
            } else {
                MY_ASSETS_LIST_EL.innerHTML = '<li>No assets won yet. Bid now!</li>';
            }
            MY_ASSETS_TOTAL_EL.textContent = formatVC(totalCost);
        }

        function renderAssetCards() {
            ASSETS_DISPLAY_EL.innerHTML = '';
            for (const id in assetCatalog) {
                const asset = assetCatalog[id];
                const teamBid = asset.current_bids[TEAM_ID] || 0;
                
                const card = document.createElement('div');
                card.className = 'item-card';
                
                let bidControlsHTML = '';
                
                // --- Winning Pool Display ---
                let winnerStatus = '';
                if (!auctionActive && asset.winner) {
                    winnerStatus = `<p style="margin-top: 10px; font-weight: bold; color: #FFC72C;">AUCTION RESULT:</p>`;
                    
                    if (asset.winner === 'MULTIPLE' && asset.winning_pool.includes(TEAM_ID)) {
                        winnerStatus += `<p style="color: #00FF00;">üéâ YOU WON 1 UNIT at ${formatVC(asset.final_price)}!</p>`;
                    } else if (asset.winner === 'MULTIPLE') {
                        winnerStatus += `<p>Sold ${asset.quantity} units. Uniform Price: ${formatVC(asset.final_price)}</p>`;
                    } else if (asset.winner === 'VOID (Budget Fail)') {
                        winnerStatus += `<p style="color: orange;">VOID: Team over budget.</p>`;
                    } else {
                        winnerStatus += `<p>No units won.</p>`;
                    }
                }
                
                if (auctionActive) {
                     bidControlsHTML = `
                        <p style="font-weight: bold;">Units Available: x${asset.quantity}</p>
                        <label for="bid-${id}">Your Bid (Price per unit):</label>
                        <input type="number" id="bid-${id}" value="${teamBid}" min="${asset.min_bid}">
                        <button onclick="placeBid('${id}')">
                            ${teamBid > 0 ? 'Update Bid' : 'Place Bid'}
                        </button>
                        <div class="bid-status" id="status-${id}">
                            ${teamBid > 0 ? `Current Bid/Unit: ${formatVC(teamBid)}` : 'No bid recorded.'}
                        </div>
                    `;
                } else {
                    bidControlsHTML = `<div class="bid-status">Auction is CLOSED.</div>`;
                }


                card.innerHTML = `
                    <h3>${asset.name} (${asset.category})</h3>
                    <p>Min Bid/Unit: ${formatVC(asset.min_bid)}</p>
                    <p>Description: Strategic value details for pitching.</p>
                    <div class="bid-section">${bidControlsHTML}</div>
                    ${winnerStatus}
                `;
                ASSETS_DISPLAY_EL.appendChild(card);
            }
        }

        window.placeBid = (assetId) => {
            const input = document.getElementById(`bid-${assetId}`);
            const bidAmount = parseInt(input.value);

            if (!auctionActive) { return; }

            if (isNaN(bidAmount) || bidAmount < assetCatalog[assetId].min_bid) {
                alert(`Bid for ${assetCatalog[assetId].name} must be a valid number and at least ${formatVC(assetCatalog[assetId].min_bid)} (per unit).`);
                return;
            }
            
            socket.emit('place_bid', {
                assetId: assetId,
                bidAmount: bidAmount
            });
        }
        
        // --- Socket.IO Event Handlers ---
        
        socket.on('initial_state', (state) => {
            TEAM_ID = state.teamId;
            updateTeamDisplay(state.teamData);
            assetCatalog = state.assets;
            auctionActive = state.active;
            
            renderAssetCards();
            STATUS_MSG_EL.textContent = auctionActive ? 'Auction is LIVE! Place your sealed bids now.' : 'Auction is CLOSED. Review results and assets.';
        });

        socket.on('timer_update', (data) => {
            const time_left = data.timeLeft;
            const minutes = Math.floor(time_left / 60);
            const seconds = time_left % 60;
            TIMER_EL.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        });
        
        socket.on('bid_response', (data) => {
            const statusEl = document.getElementById(`status-${data.assetId}`);
            if (data.success) {
                statusEl.innerHTML = `<span style="color: #00FF00;">‚úÖ ${data.message}</span>`;
                assetCatalog[data.assetId].current_bids[TEAM_ID] = data.newBid;
                document.querySelector(`#bid-${data.assetId}`).nextElementSibling.textContent = 'Update Bid';
            } else {
                statusEl.innerHTML = `<span style="color: #FF0000;">‚ùå ${data.message}</span>`;
            }
        });
        
        socket.on('auction_finished', (assetResults) => {
            auctionActive = false;
            STATUS_MSG_EL.textContent = 'AUCTION ENDED! Review your asset portfolio for Day 2.';
            assetCatalog = assetResults;
            renderAssetCards(); 
        });

        socket.on('admin_update_teams', (teamsData) => {
             if (teamsData[TEAM_ID]) {
                updateTeamDisplay(teamsData[TEAM_ID]);
             }
        });

        socket.on('auction_reset', () => {
             window.location.reload(); 
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            showSection('bidding');
        });

    </script>
</body>
</html>