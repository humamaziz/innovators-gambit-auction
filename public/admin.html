<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovator's Gambit: Admin Control Panel</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .controls, .monitor { margin-bottom: 30px; padding: 20px; border: 1px solid #112240; border-radius: 8px; }
        .controls button { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        #start-btn { background-color: #00FF00; }
        #stop-btn { background-color: orange; color: white; }
        #reset-btn { background-color: #FF0000; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #112240; padding: 10px; text-align: left; }
        th { background-color: #FFC72C; color: #0A192F; }
        .asset-bids-table { margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

    <header class="gold-rush-theme">
        <h1 class="event-title">Admin Panel: Innovator's Gambit</h1>
        <p>Status: <span id="auction-status">CLOSED</span> | Timer: <span id="timer">--:--</span></p>
    </header>

    <div class="controls">
        <h2>Auction Controls</h2>
        <form method="POST" action="/admin_action" style="display: inline;">
            <input type="hidden" name="pass" value="admin123"> 
            <button type="submit" name="action" value="start_auction" id="start-btn">
                START 30 MINUTE AUCTION
            </button>
            <button type="button" id="stop-btn" onclick="forceStopAuction()">
                FORCE STOP & RESOLVE
            </button>
            <button type="submit" name="action" value="reset_auction" id="reset-btn">
                RESET ALL (Teams & Assets)
            </button>
        </form>
    </div>

    <div class="monitor">
        <h2>Live Bid Monitor</h2>
        <table id="asset-monitor">
            <thead>
                <tr>
                    <th>Asset Name</th>
                    <th>Min Bid</th>
                    <th>Total Bidders</th>
                    <th>Highest Bid</th>
                    <th>Winner (Final Price)</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
    
    <div class="monitor">
        <h2>Team Status</h2>
        <table id="team-status-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>VC Balance</th>
                    <th>Assets Won</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        const socket = io('/admin');
        
        // --- DOM Elements ---
        const AUCTION_STATUS_EL = document.getElementById('auction-status');
        const TIMER_EL = document.getElementById('timer');
        const START_BTN = document.getElementById('start-btn');
        const STOP_BTN = document.getElementById('stop-btn'); // NEW ELEMENT
        const ASSET_MONITOR_BODY = document.querySelector('#asset-monitor tbody');
        const TEAM_STATUS_BODY = document.querySelector('#team-status-table tbody');
        
        // --- Global State ---
        let assetCatalog = {};
        let teams = {};
        
        const formatVC = (amount) => `$${amount.toLocaleString()}`;

        // --- Core Functions ---

        function updateButtonStates(isActive) {
            START_BTN.disabled = isActive;
            STOP_BTN.disabled = !isActive;
            AUCTION_STATUS_EL.textContent = isActive ? 'LIVE' : 'CLOSED';
        }
        
        function renderAssetMonitor() {
            ASSET_MONITOR_BODY.innerHTML = '';
            for (const id in assetCatalog) {
                const asset = assetCatalog[id];
                const bidCount = Object.keys(asset.current_bids).length;
                
                const highestBid = bidCount > 0 ? 
                    Math.max(...Object.values(asset.current_bids)) : 0;
                
                let winnerText = (asset.winner && AUCTION_STATUS_EL.textContent !== 'LIVE') ? 
                    `${asset.winner} (${formatVC(asset.final_price)})` : 
                    '--';

                const row = ASSET_MONITOR_BODY.insertRow();
                row.id = `asset-row-${id}`;
                
                row.innerHTML = `
                    <td>${asset.name}</td>
                    <td>${formatVC(asset.min_bid)}</td>
                    <td>${bidCount}</td>
                    <td>${formatVC(highestBid)}</td>
                    <td>${winnerText}</td>
                `;
            }
        }
        
        function renderTeamStatus() {
             TEAM_STATUS_BODY.innerHTML = '';
             for (const id in teams) {
                const team = teams[id];
                const row = TEAM_STATUS_BODY.insertRow();
                row.id = `team-row-${id}`;
                row.innerHTML = `
                    <td>${team.id}</td>
                    <td>${team.name}</td>
                    <td>${formatVC(team.vc)}</td>
                    <td>${team.assets_won.length} items</td>
                `;
             }
        }

        // --- NEW FUNCTION TO STOP THE AUCTION ---
        window.forceStopAuction = () => {
            if (confirm("Are you sure you want to STOP the auction immediately and resolve the winners based on current bids?")) {
                STOP_BTN.disabled = true; // Disable to prevent double-click
                socket.emit('force_stop_auction');
            }
        };

        // --- Socket.IO Event Handlers ---

        socket.on('initial_admin_state', (state) => {
            assetCatalog = state.assets;
            teams = state.teams;
            updateButtonStates(state.active);
            renderAssetMonitor();
            renderTeamStatus();
            
            // Set initial timer value if live
            if (state.active) {
                 const minutes = Math.floor(state.timeLeft / 60);
                 const seconds = state.timeLeft % 60;
                 TIMER_EL.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        socket.on('timer_update', (data) => {
            const time_left = data.timeLeft;
            const minutes = Math.floor(time_left / 60);
            const seconds = time_left % 60;
            TIMER_EL.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        });
        
        socket.on('admin_update_bids', (updates) => {
            for(const assetId in updates) {
                assetCatalog[assetId].current_bids = updates[assetId].current_bids;
            }
            // Only re-render the monitor for live updates
            renderAssetMonitor();
        });

        socket.on('auction_start', (data) => {
            updateButtonStates(true);
        });
        
        socket.on('auction_finished', (assetResults) => {
            TIMER_EL.textContent = '00:00';
            updateButtonStates(false);
            assetCatalog = assetResults;
            renderAssetMonitor();
            // Note: Team update (VC/Assets Won) happens via 'admin_update_teams'
        });

        socket.on('admin_update_teams', (teamsData) => {
            teams = teamsData;
            renderTeamStatus();
        });

        socket.on('auction_reset', () => {
             window.location.reload(); 
        });

        socket.on('admin_action_response', (data) => {
             if (data.success) {
                 console.log(data.message);
             } else {
                 alert(data.message);
                 // If stop failed, re-enable the button
                 updateButtonStates(true);
             }
        });

        // Initialization (set initial state on load)
        updateButtonStates(false); 
    </script>
</body>
</html>