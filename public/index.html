<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovator's Gambit: Bidding Floor</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="gold-rush-theme">
        <h1 class="event-title">Innovator's Gambit: Live Bidding</h1>
        <div id="team-info">
            <span id="team-name">Loading...</span> | 
            <span id="vc-balance">$VC 0</span>
        </div>
    </header>

    <div style="padding: 20px;">
        <h2 style="color: #E84A5F;">Time Remaining: <span id="timer">--:--</span></h2>
        <div id="status-message">Connecting...</div>
    </div>
    
    <div id="assets-display" class="item-list">
        </div>

    <script>
        // Get the Team ID from the URL (e.g., ?team=T1)
        const urlParams = new URLSearchParams(window.location.search);
        const TEAM_ID = urlParams.get('team');
        
        // --- DOM Elements ---
        const VC_BALANCE_EL = document.getElementById('vc-balance');
        const TEAM_NAME_EL = document.getElementById('team-name');
        const TIMER_EL = document.getElementById('timer');
        const STATUS_MSG_EL = document.getElementById('status-message');
        const ASSETS_DISPLAY_EL = document.getElementById('assets-display');
        
        // --- Global State ---
        let teamData = {};
        let assetCatalog = {};
        let auctionActive = false;
        
        const socket = io(); // Connect to the default namespace

        // --- Core Functions ---

        const formatVC = (amount) => `$VC ${amount.toLocaleString()}`;
        
        function updateTeamDisplay() {
            if (teamData.name) {
                TEAM_NAME_EL.textContent = `Team: ${teamData.name}`;
                VC_BALANCE_EL.textContent = formatVC(teamData.vc);
            }
        }
        
        function renderAssetCards() {
            ASSETS_DISPLAY_EL.innerHTML = '';
            for (const id in assetCatalog) {
                const asset = assetCatalog[id];
                // Get the team's bid, defaulting to 0
                const teamBid = asset.current_bids[TEAM_ID] || 0;
                
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <h3>${asset.name} (${asset.category})</h3>
                    <p>Min Bid: ${formatVC(asset.min_bid)}</p>
                    <p>Description: The asset's strategic value.</p>
                    <div class="bid-section">
                        <label for="bid-${id}">Your Current Bid:</label>
                        <input type="number" id="bid-${id}" value="${teamBid}" min="${asset.min_bid}" ${auctionActive ? '' : 'disabled'}>
                        <button onclick="placeBid('${id}')" ${auctionActive ? '' : 'disabled'}>
                            ${teamBid > 0 ? 'Update Bid' : 'Place Bid'}
                        </button>
                        <div class="bid-status" id="status-${id}">
                            ${teamBid > 0 ? `Bid recorded: ${formatVC(teamBid)}` : 'No bid recorded.'}
                        </div>
                    </div>
                `;
                
                // Show winner/price after the auction ends
                if (asset.winner) {
                    const winnerText = asset.winner === TEAM_ID ? 
                        `<span class="winner" style="color: #00FF00;">YOU WON!</span> for ${formatVC(asset.final_price)}` : 
                        asset.winner === 'VOID (Budget Fail)' ?
                        `<span style="color: orange;">Winner VOIDED.</span>` :
                        `Won by ${asset.winner} for ${formatVC(asset.final_price)}`;
                    
                    card.querySelector('.bid-section').innerHTML = `
                        <p class="winner" style="color: #FFC72C; font-weight: bold;">AUCTION RESULT:</p>
                        <p>${winnerText}</p>
                    `;
                }
                
                ASSETS_DISPLAY_EL.appendChild(card);
            }
        }

        window.placeBid = (assetId) => {
            const input = document.getElementById(`bid-${assetId}`);
            const bidAmount = parseInt(input.value);

            if (!auctionActive) {
                alert('Auction is not currently active!');
                return;
            }

            if (isNaN(bidAmount)) {
                alert('Please enter a valid number.');
                return;
            }
            
            // Send the bid to the server
            socket.emit('place_bid', {
                teamId: TEAM_ID,
                assetId: assetId,
                bidAmount: bidAmount
            });
        }
        
        // --- Socket.IO Event Handlers ---
        
        socket.on('initial_state', (state) => {
            if (state.teams[TEAM_ID]) {
                teamData = state.teams[TEAM_ID];
                assetCatalog = state.assets;
                auctionActive = state.active;
                
                updateTeamDisplay();
                renderAssetCards();
                
                STATUS_MSG_EL.textContent = auctionActive ? 'Auction is LIVE! Place your sealed bids now.' : 'Auction is CLOSED. Waiting for Admin.';
            } else {
                STATUS_MSG_EL.textContent = 'Error: Invalid team data received.';
            }
        });

        socket.on('timer_update', (data) => {
            const time_left = data.timeLeft;
            const minutes = Math.floor(time_left / 60);
            const seconds = time_left % 60;
            TIMER_EL.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        });
        
        socket.on('bid_response', (data) => {
            const statusEl = document.getElementById(`status-${data.assetId}`);
            if (data.success) {
                statusEl.innerHTML = `<span style="color: #00FF00;">✅ ${data.message}</span>`;
                // Update local bid state and button text
                assetCatalog[data.assetId].current_bids[TEAM_ID] = data.newBid;
                document.querySelector(`#bid-${data.assetId}`).nextElementSibling.textContent = 'Update Bid';
            } else {
                statusEl.innerHTML = `<span style="color: #FF0000;">❌ ${data.message}</span>`;
            }
        });
        
        socket.on('auction_finished', (assetResults) => {
            auctionActive = false;
            STATUS_MSG_EL.textContent = 'AUCTION ENDED! Review your asset portfolio for Day 2.';
            // Disable all bidding inputs/buttons
            document.querySelectorAll('.item-card button, .item-card input').forEach(el => el.disabled = true);
            
            assetCatalog = assetResults;
            renderAssetCards(); 
        });

        socket.on('auction_reset', () => {
             // Reload the page to get the fresh state from the server
             window.location.reload(); 
        });

    </script>
</body>
</html>